{% extends 'base.html' %}

{% block header %}
  <h1>{% block title %}Movie{% endblock %}</h1>
{% endblock %}

{% block content %}
    <body>
    <div id="video_div" style="position: relative; width: 100%; height: 100%;">
    <video id="video_id" src="{{url_for('static', filename='/uploads/'+title+'.mp4')}}" height = "100%" width="100%" controls></video>
    <script>
        let video = document.getElementById('video_id');
        let bounding_boxes = [];
        video.addEventListener('pause', function() {
            let currentFrame = video.currentTime * 24;
            //console.log('Current frame:', currentFrame);
            //console.log('Title:', '{{title}}')
            fetch('/pause_video', {
                method: 'POST',
                headers: {
                        'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    'title': '{{title}}',
                    'frame_id': currentFrame,
                    'height': video.videoHeight,
                    'width': video.videoWidth,
                })
            }).then(response => response.json())
                .then((data) => {
                    //console.log("Bounding boxes found " +data.bounding_boxes);
                    //console.log("Number of bounding boxes " +data.bounding_boxes.length.toString());
                    for(let i = 0; i < data.bounding_boxes.length; i++) {
                        let bounding_box = data.bounding_boxes[i];
                        console.log(data.bounding_boxes);
                        let overlay_string = document.createElement('div');
                        overlay_string.setAttribute('id', 'overlay_string_'+i.toString());
                        overlay_string.style.position = 'absolute';
                        // compute the position to place the string
                        let topValue = (parseInt(bounding_box[0]) + parseInt(bounding_box[2]) * 0.5).toString() + "px";
                        let leftValue = (parseInt(bounding_box[1]) + parseInt(bounding_box[3]) * 0.5).toString() + "px";
                        //console.log(topValue, leftValue);
                        overlay_string.style.top = topValue;
                        overlay_string.style.left = leftValue;
                        overlay_string.style.color = 'red';
                        overlay_string.style.fontSize = '24px';
                        overlay_string.style.fontWeight = 'bold';
                        overlay_string.innerText = "black t-shirt";
                        overlay_string.style.display = 'block';
                        video.parentElement.appendChild(overlay_string);
                        bounding_boxes.push(overlay_string);
                    }
                }).catch(error => console.error(error));
            video.addEventListener('play', function() {
                for(let i = 0; i < bounding_boxes.length; i++) {
                    let overlay_string = document.getElementById('overlay_string_'+i.toString());
                    overlay_string.remove();
                    bounding_boxes.pop();
                }
            });
        });
    </script>
    </div>
    </body>
{% endblock %}


